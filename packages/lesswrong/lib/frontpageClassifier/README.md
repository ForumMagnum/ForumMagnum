# Frontpage Classifier

This module implements a server-side machine learning classifier that predicts whether posts should be on the frontpage based on their semantic embeddings.

## Overview

The classifier uses:
- **Input**: 1536-dimensional embedding vectors from OpenAI's text-embedding model (stored in PostEmbeddings table)
- **Algorithm**: Logistic regression with weighted loss function
- **Output**: Binary prediction (frontpage/personal) with probability score
- **Special Feature**: False positives are weighted 4x more heavily than false negatives during training
- **Architecture**: Serverless-friendly with GraphQL field resolver integration

## Components

### 1. Training Pipeline (`/server/scripts/frontpageClassifier/trainClassifier.ts`)

Extracts training data from the database and trains the classifier.

**Usage:**
```bash
yarn repl prod packages/lesswrong/server/scripts/frontpageClassifier/trainClassifier.ts "trainFrontpageClassifier()"
```

**Options:**
```typescript
trainFrontpageClassifier(
  startDate,  // Optional: Start date for training data (default: 2023-01-01)
  endDate,    // Optional: End date for training data (default: 2024-01-01)
  {
    falsePositiveWeight: 4,    // Weight for false positives (default: 4)
    falseNegativeWeight: 1,     // Weight for false negatives (default: 1)
    learningRate: 0.01,         // Learning rate for gradient descent
    epochs: 1000,               // Number of training epochs
    testRatio: 0.2              // Fraction of data for testing
  }
)
```

**Output**: Generates `model.ts` with TypeScript-typed model weights and metadata.

### 2. Logistic Regression Implementation (`logisticRegression.ts`)

Pure TypeScript implementation of logistic regression with:
- Gradient descent optimization
- Weighted loss function for asymmetric costs
- Xavier weight initialization
- Early stopping
- Comprehensive evaluation metrics

### 3. Model Storage (`model.ts`)

TypeScript file containing:
- Model weights and bias as typed constants
- Training metadata (accuracy, precision, recall, threshold, etc.)
- Exported interfaces for type safety
- Auto-generated by training script

### 4. Prediction Functions (`/server/frontpageClassifier/predictions.ts`)

Stateless pure functions that:
- Create fresh model instances on each invocation (no caching)
- Fetch embeddings from PostEmbeddings table
- Return predictions with probability scores
- Support single and batch classification

**API:**
```typescript
// Classify a single post
const prediction = await classifyPost(postId);
// Returns: { isFrontpage: boolean, probability: number } | null

// Classify multiple posts
const predictions = await classifyPosts(postIds);
// Returns: Record<string, { isFrontpage: boolean, probability: number }>
```

### 5. GraphQL Integration

**Field Resolver** (`/server/collections/posts/queries.ts`):
- Adds `frontpageClassification` field to Post type
- Admin-only access control
- Automatically called when field is requested in queries

**GraphQL Schema:**
```graphql
type Post {
  # ... other fields
  frontpageClassification: FrontpageClassification
}

type FrontpageClassification {
  isFrontpage: Boolean!
  probability: Float!  # Probability of being frontpage (0-1)
}
```

**Fragment** (`/lib/collections/posts/fragments.ts`):
```graphql
fragment SunshinePostsList on Post {
  # ... other fields
  frontpageClassification {
    isFrontpage
    probability
  }
}
```

### 6. UI Integration (`SunshineNewPostsItem.tsx`)

Shows predictions in the Sunshine sidebar with:
- Data automatically loaded with post fragment (no separate API call)
- Green badge for frontpage predictions
- Grey badge for personal predictions
- Confidence percentage displayed in predicted direction

**Display Logic:**
```typescript
// Probability always represents "probability of frontpage"
// For display, show confidence in the predicted direction:
const displayProbability = prediction.isFrontpage
  ? prediction.probability      // Already in right direction
  : 1 - prediction.probability; // Flip for personal posts
```

## Training Process

1. **Data Collection**: Queries posts with embeddings and known frontpage status
2. **Feature Extraction**: Uses 1536-dimensional embeddings from PostEmbeddings table
3. **Label Assignment**: `frontpageDate` presence determines labels
4. **Train/Test Split**: Stratified 80/20 split maintaining class balance
5. **Training**: Gradient descent with weighted cross-entropy loss
6. **Threshold Optimization**: Finds optimal decision threshold considering costs
7. **Model Export**: Generates TypeScript file with weights and metadata

## Weighted Loss Function

The classifier uses an asymmetric loss function where false positives (incorrectly predicting a post as frontpage) cost 4x more than false negatives:

```
Cost = 4 × False Positives + 1 × False Negatives
```

This ensures the classifier is conservative about recommending posts for the frontpage.

## Deployment

1. **Train the model**:
   ```bash
   yarn repl prod packages/lesswrong/server/scripts/frontpageClassifier/trainClassifier.ts "trainFrontpageClassifier()"
   ```

2. **Verify model file exists**:
   Check that `packages/lesswrong/lib/frontpageClassifier/model.ts` was created

3. **Commit and deploy**:
   The TypeScript model is imported at build time - no runtime file loading

4. **Monitor performance**:
   - Check the training output for accuracy metrics
   - Review misclassification examples
   - Monitor prediction badges in Sunshine sidebar

## Architecture

### Serverless-Friendly Design

```
┌─────────────────────┐
│   GraphQL Query     │
│  (with fragment)    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  Field Resolver     │
│  (admin-only)       │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ Prediction Function │
│ (creates model)     │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  PostEmbeddings DB  │
└─────────────────────┘
```

**Key Features:**
- Stateless functions with no module-level caching
- Fresh model instances created on each invocation
- Pure functions for easy testing
- TypeScript model imported at build time
- Field resolver integrates with GraphQL caching

### Data Flow

1. Client requests post with `frontpageClassification` fragment
2. GraphQL resolver checks admin permissions
3. `classifyPost()` function creates fresh model instance
4. Embeddings fetched from database
5. Model predicts probability
6. Result returned via GraphQL (cached by Apollo)
7. UI displays prediction badge

## Retraining

The model should be retrained periodically as:
- New posts accumulate
- Frontpage standards evolve
- Embedding model updates

**Process:**
1. Run training script with updated date range
2. Review metrics and misclassifications
3. Commit new `model.ts` file
4. Deploy (no server restart needed - serverless picks up new code)

Recommended retraining frequency: Monthly or quarterly

## Performance Metrics

The classifier reports:
- **Accuracy**: Overall correct predictions
- **Precision**: True positives / (True positives + False positives)
- **Recall**: True positives / (True positives + False negatives)
- **F1 Score**: Harmonic mean of precision and recall
- **Weighted Loss**: Cost-adjusted loss considering asymmetric penalties
- **Optimal Threshold**: Decision boundary that minimizes weighted cost

## Troubleshooting

### "Placeholder model detected" error
- Run the training script to generate a real model
- Check that `model.ts` has `trainingSetSize > 0`
- Verify training script completed successfully

### No predictions returned (null)
- Verify posts have embeddings in PostEmbeddings table
- Check that user has admin permissions
- Posts without embeddings return `null` (expected behavior)

### Low accuracy
- Increase training data date range
- Adjust learning rate or epochs
- Review misclassified examples for patterns
- Consider adjusting the threshold or cost weights

## Security

- Field resolver requires admin authentication
- Embeddings never leave the server
- Model weights embedded in server code at build time
- Predictions only accessible via authenticated GraphQL
