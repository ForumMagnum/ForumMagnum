import React, { useState } from 'react';
import { registerComponent, Components } from '../../lib/vulcan-lib';
import { Hits, Configure, InstantSearch, SearchBox, Pagination, connectStateResults, connectRefinementList, ToggleRefinement } from 'react-instantsearch-dom';
import { getAlgoliaIndexName, isAlgoliaEnabled, getSearchClient, AlgoliaIndexCollectionName } from '../../lib/algoliaUtil';
import Tab from '@material-ui/core/Tab';
import Tabs from '@material-ui/core/Tabs';
import SearchIcon from '@material-ui/icons/Search';
import { useLocation, useNavigation } from '../../lib/routeUtil';
import { taggingNameIsSet, taggingNamePluralCapitalSetting, taggingNamePluralSetting } from '../../lib/instanceSettings';
import qs from 'qs';
import classNames from 'classnames';

const styles = (theme: ThemeType): JssStyles => ({
  root: {
    width: "100%",
    maxWidth: 1200,
    display: 'flex',
    columnGap: 40,
    padding: '0 10px',
    margin: "auto",
    [theme.breakpoints.down('sm')]: {
      display: 'block',
      paddingTop: 24,
    }
  },
  filtersColumn: {
    flex: 'none',
    width: 250,
    fontFamily: theme.typography.fontFamily,
    color: theme.palette.grey[800],
    paddingTop: 12,
    [theme.breakpoints.down('sm')]: {
      display: 'none'
    },
    '& .ais-ToggleRefinement-label': {
      display: 'flex',
      columnGap: 6,
      alignItems: 'center',
      marginTop: 10
    }
  },
  filtersHeadline: {
    marginBottom: 18
  },
  resultsColumn: {
    flex: '1 1 0',
  },
  
  tabs: {
    margin: '0 auto 30px',
    [theme.breakpoints.down('sm')]: {
      marginBottom: 20
    },
    '& .MuiTab-root': {
      minWidth: 110,
      [theme.breakpoints.down('xs')]: {
        minWidth: 50
      }
    },
    '& .MuiTab-labelContainer': {
      fontSize: '1rem'
    }
  },
  
  // searchList: {
  //   // width: 300,
  //   [theme.breakpoints.down('sm')]: {
  //     width: "100%",
  //     borderBottom: theme.palette.border.faint,
  //     order: 1,
  //     maxWidth: 625,
  //   },
  // },
  // usersList: {
  //   // width: 220,
  //   [theme.breakpoints.down('sm')]: {
  //     width: "100%",
  //     maxWidth: 625,
  //     borderBottom: theme.palette.border.faint,
  //     paddingBottom: 8
  //   }
  // },
  // tagsList: {
  //   // width: 220,
  //   [theme.breakpoints.down('sm')]: {
  //     width: "100%",
  //     maxWidth: 625,
  //     borderBottom: theme.palette.border.faint,
  //     paddingBottom: 8
  //   }
  // },
  searchIcon: {
    marginLeft: 12
  },
  searchInputArea: {
    display: "flex",
    alignItems: "center",
    maxWidth: 625,
    marginBottom: 30,
    height: 48,
    border: theme.palette.border.slightlyIntense2,
    borderRadius: 3,
    [theme.breakpoints.down('xs')]: {
      marginBottom: 12,
    },
    "& .ais-SearchBox": {
      display: 'inline-block',
      position: 'relative',
      width: '100%',
      marginLeft: 12,
      height: 46,
      whiteSpace: 'nowrap',
      boxSizing: 'border-box',
    },
    "& .ais-SearchBox-form": {
      height: '100%'
    },
    "& .ais-SearchBox-submit":{
      display: "none"
    },
    // This is a class generated by React InstantSearch, which we don't have direct control over so
    // are doing a somewhat hacky thing to style it.
    "& .ais-SearchBox-input": {
      height: "100%",
      width: "100%",
      paddingRight: 0,
      verticalAlign: "bottom",
      borderStyle: "none",
      boxShadow: "none",
      backgroundColor: "transparent",
      fontSize: 'inherit',
      "-webkit-appearance": "none",
      cursor: "text",
      ...theme.typography.body2,
    },
  },
  pagination: {
    ...theme.typography.commentStyle,
    fontSize: 16,
    marginTop: 6,
    '& li': {
      padding: 8
    },
    '& .ais-Pagination-item': {
      color: theme.palette.primary.main,
    },
    '& .ais-Pagination-item--page': {
      fontWeight: 600
    },
    '& .ais-Pagination-item--selected': {
      color: theme.palette.grey[900]
    },
    '& .ais-Pagination-item--disabled': {
      color: theme.palette.grey[500]
    }
  }
})

const RefinementList = ({
  items,
  searchForItems,
  refine,
  createURL,
}) => {
  return <Components.TagMultiselect
    value={items.filter(i => i.isRefined).map(i => i.label)}
    path="tags"
    placeholder={`Filter by ${taggingNamePluralSetting.get()}`}
    updateCurrentValues={(val) => {
      console.log('createURL', createURL(val.tags))
      refine(val.tags)
    }}
  />
}

const CustomRefinementList = connectRefinementList(RefinementList)

const SearchPageTabbed = ({classes}:{
  classes: ClassesType
}) => {
  const { history } = useNavigation()
  const { location, query } = useLocation()

  const [tab, setTab] = useState<AlgoliaIndexCollectionName>(query.contentType ?? 'Posts')
  const [tagsFilter, setTagsFilter] = useState([])

  const { ErrorBoundary, ExpandedUsersSearchHit, ExpandedPostsSearchHit, ExpandedCommentsSearchHit, ExpandedTagsSearchHit, ExpandedSequencesSearchHit, Typography } = Components
  
  const handleChangeTab = (e, value) => {
    setTab(value)
    history.replace({...location, search: qs.stringify({contentType: value})})
  }

  if (!isAlgoliaEnabled()) {
    return <div className={classes.root}>
      Search is disabled (Algolia App ID not configured on server)
    </div>
  }
  
  const hitComponents = {
    'Posts': ExpandedPostsSearchHit,
    'Comments': ExpandedCommentsSearchHit,
    'Tags': ExpandedTagsSearchHit,
    'Sequences': ExpandedSequencesSearchHit,
    'Users': ExpandedUsersSearchHit
  }
  const HitComponent = hitComponents[tab]
  
  
  const hitsPerPage = 15
  
  const ResultsCount = ({ searchResults }) => {
    if (!searchResults || !searchResults.nbHits) return null
    
    // return <div>({searchResults.nbHits})</div>
    
    const start = hitsPerPage * searchResults.page + 1
    const end = Math.min(hitsPerPage * (searchResults.page + 1) + 1, searchResults.nbHits)
    
    return <div className={classes.noResults}>
      <div className={classes.noResultsText}>Showing {start}-{end} of total {searchResults.nbHits} results</div>
    </div>
  }
  const CustomStateResults = connectStateResults(ResultsCount)

  return <div className={classes.root}>
    <InstantSearch
      indexName={getAlgoliaIndexName(tab)}
      searchClient={getSearchClient()}
    >
    <div className={classes.filtersColumn}>
      <Typography variant="headline" className={classes.filtersHeadline}>Filters</Typography>
      {['Posts', 'Comments', 'Users'].includes(tab) && <CustomRefinementList attribute="tags" />}
      {tab === 'Posts' && <ToggleRefinement
        attribute="curated"
        label="Curated"
        value={true}
      />}
      {tab === 'Tags' && <ToggleRefinement
        attribute="isSubforum"
        label="Has subforum"
        value={true}
      />}
    </div>

    <div className={classes.resultsColumn}>
      <div className={classes.searchInputArea}>
        <SearchIcon className={classes.searchIcon}/>
        {/* Ignored because SearchBox is incorrectly annotated as not taking null for its reset prop, when
          * null is the only option that actually suppresses the extra X button.
         // @ts-ignore */}
        <SearchBox defaultRefinement={query.terms} reset={null} focusShortcuts={[]} autoFocus={true} />
      </div>
      
      <Tabs
        value={tab}
        onChange={handleChangeTab}
        className={classes.tabs}
        textColor="primary"
        aria-label="select content type to search"
        scrollable
        scrollButtons="off"
      >
        <Tab label="Posts" value="Posts" />
        <Tab label="Comments" value="Comments" />
        <Tab label={taggingNameIsSet.get() ? taggingNamePluralCapitalSetting.get() : 'Tags and Wiki'} value="Tags" />
        <Tab label="Sequences" value="Sequences" />
        <Tab label="Users" value="Users" />
      </Tabs>
      
      <ErrorBoundary>
        <div className={classes.searchList}>
            <Configure hitsPerPage={hitsPerPage} />
            <Hits hitComponent={(props) => <HitComponent {...props} />} />
            <Pagination showLast className={classes.pagination} />
            <CustomStateResults />
        </div>
      </ErrorBoundary>
    </div>
    </InstantSearch>
  </div>
}

const SearchPageTabbedComponent = registerComponent("SearchPageTabbed", SearchPageTabbed, {styles})

declare global {
  interface ComponentTypes {
    SearchPageTabbed: typeof SearchPageTabbedComponent
  }
}
