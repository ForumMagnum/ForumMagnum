#!/bin/bash

print_help () {
  cat <<-END
		Usage: scripts/runDevInstance.sh [environment-name] [nextjs-options]

		Syncs environment variables from a Vercel environment that is linked to the current
		working directory, then runs a development server. Any options after the environment
		name are passed through to nextjs.
	END
}

while [[ "$#" != 0 ]]; do
  case "$1" in
    -h|--help)
	    print_help
	    exit 1
	    ;;
    *)
      VERCEL_ENV_NAME="$1"
      shift
      break
  esac
done
if [[ "$VERCEL_ENV_NAME" == "" ]]; then
  print_help
  exit 1
fi


# Sync environment variables from a linked Vercel environment with `vercel env pull`.
# Suppress the spammy output, then show the output iff the command fails.
pull_envvars () {
  # The 2>&1 here merges stdout and stderr. Unfortunately "vercel env pull"
  # outputs everything (including non-error spammy status information) to
  # stderr, so the customary "redirect stdout but show stderr" doesn't work.
  VERCEL_PULL_OUTPUT=$(vercel env pull .env.local --environment=${VERCEL_ENV_NAME:-development} 2>&1)
  VERCEL_PULL_EXIT_STATUS="$?"
  
  if [[ "$VERCEL_PULL_EXIT_STATUS" != 0 ]]; then
    echo "Syncing environment variables from Vercel failed"
    echo "$VERCEL_PULL_OUTPUT"
    exit 1
  fi
  
  return "$VERCEL_PULL_EXIT_STATUS"
}

run_dev_server () {
	# We use node directly rather than going through yarn so that we can use some
	# flags to silence spammy console logs on start.
	#
	# Node flags used:
  #   --inspect: Enable debugging
  #   --inspect-publish-uid=http: Suppress message about how to connect to the debugger
  #   --no-deprecation: Suppress deprecation warnings about punycode
  # The command itself: ./node_modules/.bin/next dev
  # Nextjs flags used:
  #    --turbopack: Enables the beta turbopack bundler. Makes route compilation
  #        ~2x faster, at the expense of bugs that, as far as we know, don't
  #        impact development.
  #    "$@": Pass through exra arguments that were passed to the script, eg --port
  node --inspect --inspect-publish-uid=http --no-deprecation ./node_modules/.bin/next dev --turbopack "$@"
}

pull_envvars && \
  run_dev_server "$@"
